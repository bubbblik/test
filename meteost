#include <Wire.h> 
#include <LiquidCrystal_I2C.h>
#include "cactus_io_BME280_I2C.h"
#include "RTClib.h"
#include "GyverButton.h"
#include "GyverTimer.h" 
#include <MQ135.h>

RTC_DS3231 rtc;
BME280_I2C bme;
MQ135 gasSensor = MQ135(A1);

GButton btn1 (4, LOW_PULL, NORM_OPEN);
GTimer_ms page1(5000);
GTimer_ms page2(5000);
GTimer_ms page3(5000);

LiquidCrystal_I2C lcd(0x27,20,4); 

char daysOfTheWeek[7][12] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
int aFlag=0; // флаг для alarm

byte prs[] = {0x4,0x2,0x2,0x4,0x15,0xe,0x4,0x1f};
byte tem[] = {0x4,0xa,0xa,0xa,0x11,0x1f,0xe,0x0};
byte hum[] = {0x3,0x6,0xe,0x1f,0x17,0x13,0xe,0x0};
byte timer[] = {  B00000, B00000, B00110, B01010, B10001, B11111, B00000, B00000};

int counter = 0;  
long counter_set = 0;
bool dop = 1; //костыль

#define hold 1000           // время (мс), после которого кнопка считается зажатой
#define debounce 80        // (мс), антидребезг
unsigned long button1_timer; // таймер последнего нажатия кнопки

//---------------------------------НАСТРОЙКИ--------------------

void setup()
{
    
    Serial.begin(9600);

    if (!bme.begin()) {
    Serial.println("Could not find a valid BME280 sensor, check wiring!");
    while (1);
    }
      
    bme.setTempCal(-2);// Temp was reading high so subtract 1 degree
    
    if (! rtc.begin()) {
      Serial.println("Couldn't find RTC");
      while (1);
    }
    //rtc.adjust(DateTime(F(__DATE__), F(__TIME__))); ОТЛАДКА ВРЕМЕНИ(ЕСЛИ СБИЛОСЬ ВРЕМЯ)
  
    if (rtc.lostPower()) {
      Serial.println("RTC lost power, lets set the time!");
      rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
    }  
    lcd.init();                      
    lcd.backlight(); 
}
//---------------------------------ГЛАВНАЯ--------------------
void loop()
{ 
  btn1.tick(); 
    switch (counter){
      case 0:
      firstPage();      
      dop = 0;
      break;
      case 1:
      secondPage();
      dop = 0;
      break;
    }

  if (counter > 1)
    counter = 0;
  
  if (btn1.isClick()){
  counter++;
  lcd.clear();
  dop = 1;
  }
  
  if(btn1.isHolded()){
  counter = 0;
  lcd.clear();
  dop = 1;
  }  
  
}


uint8_t LT[8] = {B00111, B01111, B11111, B11111, B11111, B11111, B11111, B11111};
uint8_t UB[8] = {B11111, B11111, B11111, B00000, B00000, B00000, B00000, B00000};
uint8_t RT[8] = {B11100, B11110, B11111, B11111, B11111, B11111, B11111, B11111};
uint8_t LL[8] = {B11111, B11111, B11111, B11111, B11111, B11111, B01111, B00111};
uint8_t LB[8] = {B00000, B00000, B00000, B00000, B00000, B11111, B11111, B11111};
uint8_t LR[8] = {B11111, B11111, B11111, B11111, B11111, B11111, B11110, B11100};
uint8_t MB[8] = {B11111, B11111, B11111, B00000, B00000, B00000, B11111, B11111};
uint8_t block[8] = {B11111, B11111, B11111, B11111, B11111, B11111, B11111, B11111};

// ------------------------------------ЧАСИКИ-------------------------
void custom0(int x)
{ // uses segments to build the number 0

  lcd.setCursor(x,0); // set cursor to column 0, line 0 (first row)
  lcd.write(0);  // call each segment to create
  lcd.write(1);  // top half of the number
  lcd.write(2);
  lcd.setCursor(x, 1); // set cursor to colum 0, line 1 (second row)
  lcd.write(3);  // call each segment to create
  lcd.write(4);  // bottom half of the number
  lcd.write(5);
}

void custom1(int x)
{
  lcd.setCursor(x,0);
  lcd.write(1);
  lcd.write(2);
  lcd.print(" ");
  lcd.setCursor(x,1);
  lcd.write(4);
  lcd.write(7);
  lcd.write(4);
}

void custom2(int x)
{
  lcd.setCursor(x,0);
  lcd.write(6);
  lcd.write(6);
  lcd.write(2);
  lcd.setCursor(x, 1);
  lcd.write(3);
  lcd.write(4);
  lcd.write(4);
}

void custom3(int x)
{
  lcd.setCursor(x,0);
  lcd.write(6);
  lcd.write(6);
  lcd.write(2);
  lcd.setCursor(x, 1);
  lcd.write(4);
  lcd.write(4);
  lcd.write(5); 
}

void custom4(int x)
{
  lcd.setCursor(x,0);
  lcd.write(3);
  lcd.write(4);
  lcd.write(7);
  lcd.setCursor(x, 1);
  lcd.print(" ");
  lcd.print(" ");
  lcd.write(7);
}

void custom5(int x)
{
  lcd.setCursor(x,0);
  lcd.write(3);
  lcd.write(6);
  lcd.write(6);
  lcd.setCursor(x, 1);
  lcd.write(4);
  lcd.write(4);
  lcd.write(5);
}

void custom6(int x)
{
  lcd.setCursor(x,0);
  lcd.write(0);
  lcd.write(6);
  lcd.write(6);
  lcd.setCursor(x, 1);
  lcd.write(3);
  lcd.write(4);
  lcd.write(5);
}

void custom7(int x)
{
  lcd.setCursor(x,0);
  lcd.write(1);
  lcd.write(1);
  lcd.write(2);
  lcd.setCursor(x, 1);
  lcd.print(" ");
  lcd.print(" ");
  lcd.write(7);
}

void custom8(int x)
{
  lcd.setCursor(x,0);
  lcd.write(0);
  lcd.write(6);
  lcd.write(2);
  lcd.setCursor(x, 1);
  lcd.write(3);
  lcd.write(4);
  lcd.write(5);
}

void custom9(int x)
{
  lcd.setCursor(x,0);
  lcd.write(0);
  lcd.write(6);
  lcd.write(2);
  lcd.setCursor(x, 1);
  lcd.print(" ");
  lcd.print(" ");
  lcd.write(7);

}

void dot(int x){ 
  lcd.setCursor(x, 0);
  lcd.write(4);
  lcd.setCursor(x, 1);
  lcd.write(1);
}

void print1(int digits, int x){
  lcd.createChar(0,LT);
  lcd.createChar(1,UB);
  lcd.createChar(2,RT);
  lcd.createChar(3,LL);
  lcd.createChar(4,LB);
  lcd.createChar(5,LR);
  lcd.createChar(6,MB);
  lcd.createChar(7,block);
  // utility function for digital clock display: prints preceding colon and leading 0

  switch (digits) {
  case 0:  
    custom0(x);
    break;
  case 1:  
    custom1(x);
    break;
  case 2:  
    custom2(x);
    break;
  case 3:  
    custom3(x);
    break;
  case 4:  
    custom4(x);
    break;
  case 5:  
    custom5(x);
    break;
  case 6:  
    custom6(x);
    break;
  case 7:  
    custom7(x);
    break;
  case 8:  
    custom8(x);
    break;
  case 9:  
    custom9(x);
    break;
  }

}

// ------------------------------------ПЕРВАЯ СТРАНИЦА-------------------------
void firstPage(){
  Serial.print("1");
  
  if (millis()-counter_set>=5000 || dop == 1){
          DateTime now = rtc.now();
          lcd.createChar(0, hum);
          lcd.createChar(1, tem);
          lcd.createChar(2, prs);
          lcd.createChar(3, timer);
          
          bme.readSensor();
          float prs = (bme.getPressure_MB()*100)/133.3; 
              
          lcd.setCursor(0,0);
          lcd.write(1); 
          lcd.print(" Tem: ");
          lcd.print(bme.getTemperature_C());
          lcd.print(" C");        
            
          lcd.setCursor(0,1); 
          lcd.write(0);             
          lcd.print(" Hum: ");
          lcd.print(bme.getHumidity());
          lcd.print(" %");
            
          lcd.setCursor(0,2);
          lcd.write(2); 
          lcd.print(" Prs: ");
          lcd.print(prs); 
          lcd.print(" mmHg"); 

          lcd.setCursor(0,3);
          lcd.write(3);
          lcd.print(" CO2: ");
          lcd.print(gasSensor.getPPM());
          lcd.print(" ppm");

          if(gasSensor.getPPM()>750 && aFlag==0){
            alert(1, 3);
            aFlag = 1;
          }
      
          if(gasSensor.getPPM()<=750 && aFlag==1){
            disalert(1, 3);
            aFlag = 0;
          }
          
          counter_set = millis();
          
  }
}

// ------------------------------------ВТОРАЯ СТРАНИЦА-------------------------

void secondPage(){
  if (millis()-counter_set>=5000 || dop == 1){
    
    digitalClockDisplay();
    printDay();
    bmePrint();

    if(gasSensor.getPPM()>750 && aFlag==0){
      alert(0, 3);
      aFlag = 1;
    }

    if(gasSensor.getPPM()<=750 && aFlag==1){
      disalert(0, 3);
      aFlag = 0;
    }
          
    counter_set = millis();
  }
}

// ------------------------------------АЛЕРТЫ-------------------------
void alert(int x, int y) { 
  lcd.setCursor(x, y);
  lcd.write(7);
}

void disalert(int x, int y){
  lcd.setCursor(x, y);
  lcd.print(" ");
}

void thirdPage(){
  
}

// ------------------------------------ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ-------------------------

void bmePrint(){
  bme.readSensor();
  
  lcd.setCursor(1, 3);
  lcd.print(int(gasSensor.getPPM()));
  lcd.print("ppm");
  
  lcd.setCursor(10, 3);
  lcd.print(int(bme.getTemperature_C()));
  lcd.print("C");
  
  lcd.setCursor(15, 3);
  lcd.print(int(bme.getHumidity()));
  lcd.print("%");
}

void digitalClockDisplay(){
  // digital clock display of the time
  DateTime now = rtc.now();

  int hour01 = now.hour()/10;
  int hour11 = now.hour()%10;  

  print1(hour01,1); 
  print1(hour11,5); 

  dot(9);

  print1(now.minute()/10,11);
  print1(now.minute()%10,15);
}

void printDay(){

  DateTime now = rtc.now();
  
  lcd.setCursor(1, 2);
  lcd.print(daysOfTheWeek[now.dayOfTheWeek()]);
  lcd.setCursor(10, 2);
  lcd.print(now.day(), DEC);
  lcd.print('/');
  lcd.print(now.month(), DEC);
  lcd.print('/');
  lcd.print(now.year(), DEC);
}
  case 5:  
    custom5(x);
    break;
  case 6:  
    custom6(x);
    break;
  case 7:  
    custom7(x);
    break;
  case 8:  
    custom8(x);
    break;
  case 9:  
    custom9(x);
    break;

  }

}
